<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aventurier de Mirval ‚Äî Director's Cut</title>
<meta name="theme-color" content="#0e0f13" />
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#0e0f13; --panel:#171923; --accent:#6ee7b7; --muted:#a6b0c0; --danger:#ef4444; --warn:#f59e0b; --ok:#22c55e; --info:#60a5fa;
    --text:#e5e7eb; --btn:#1f2937; --btn-hover:#273244;
  }
  *{box-sizing:border-box} body{margin:0;background:#0e0f13;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
  h1{margin:0;font-size:clamp(1.1rem,2.6vw,1.8rem)} .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #1f2a3a;color:var(--muted)}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:14px} @media (max-width:860px){.grid{grid-template-columns:1fr}}
  .panel{background:linear-gradient(180deg,#151826,#0f1320);border:1px solid #273244;border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04)}
  .title{display:flex;align-items:center;gap:10px} .title h2{margin:0;font-size:1.05rem} .meta{color:var(--muted);font-size:12px}
  .stat{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;margin:6px 0;padding:8px 10px;border-radius:10px;background:linear-gradient(180deg,#111422,#0c101b);border:1px solid #222a3a}
  .attrs,.chips{display:flex;flex-wrap:wrap;gap:6px} .chip{background:#0f1422;border:1px solid #22304a;color:#b9c2d0;border-radius:999px;padding:4px 8px;font-size:12px}
  .inv{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .bar{height:10px;background:#0b0e15;border-radius:999px;overflow:hidden;border:1px solid #2a3448} .bar>i{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#34d399);width:50%}
  .log{height:260px;overflow:auto;background:linear-gradient(180deg,#0d111b,#0a0f18);border:1px solid #213049;border-radius:12px;padding:10px;font-size:14px}
  .log p{margin:0 0 8px} .log .sys{color:#9aa3b2} .log .good{color:var(--ok)} .log .bad{color:var(--danger)} .log .warn{color:var(--warn)} .log .info{color:var(--info)}
  .divider{height:1px;background:#243044;margin:10px 0}
  .choices{display:grid;gap:10px;margin-top:10px}
  button{appearance:none;border:0;background:var(--btn);color:#e7ecf5;padding:16px 18px;border-radius:12px;cursor:pointer;border:1px solid #2c3a54;transition:transform .05s ease, background .12s ease, border-color .12s ease;text-align:left;font-size:18px;line-height:1.3}
  button:hover{background:var(--btn-hover);border-color:#3a4a68} button:active{transform:translateY(1px)} .btn-primary{background:#1c2a3d;border-color:#3a4a68} .btn-danger{background:#3a1f22;border-color:#6b2d33} .btn-ghost{background:transparent;border-color:#334155}
  .footer{margin-top:10px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:#9aa3b2;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üó°Ô∏è Aventurier de Mirval ‚Äî Director's Cut</h1>
      <span class="badge">JDR solo ‚Äî qu√™tes, r√©putation, classes & combats √©volu√©s</span>
    </header>

    <div class="grid">
      <aside class="panel">
        <div class="title"><h2>Personnage</h2><span class="meta" id="seedInfo"></span></div>
        <div class="stat"><b>Nom</b><span id="p-name">Eldarion</span></div>
        <div class="stat"><b>Classe</b><span id="p-class">‚Äî</span></div>
        <div class="attrs">
          <span class="chip">STR <b id="a-str">1</b></span>
          <span class="chip">AGI <b id="a-agi">1</b></span>
          <span class="chip">WIS <b id="a-wis">1</b></span>
          <span class="chip">R√©putation <b id="rep-label">Neutre</b> (<span id="rep">0</span>)</span>
        </div>
        <div class="stat">
          <b>Vie</b><span><span id="hp">20</span>/<span id="hpmax">20</span></span>
          <div class="bar" style="grid-column:1 / -1;"><i id="hpbar" style="width:100%"></i></div>
        </div>
        <div class="stat"><b>Or</b><span id="gold">10</span></div>
        <div class="stat"><b>Niveau</b><span id="lvl">1</span></div>
        <div class="stat"><b>Exp√©rience</b><span id="xp">0</span></div>
        <div class="stat"><b>√âtats</b><span id="status">‚Äî</span></div>
        <div class="divider"></div>
        <div class="title"><h2>Inventaire</h2></div>
        <div class="inv" id="inventory"></div>
        <div class="divider"></div>
        <div class="title"><h2>Qu√™tes</h2></div>
        <div id="quests" class="inv"></div>
        <div class="divider"></div>
        <div class="title"><h2>Actions</h2></div>
        <div class="chips">
          <button id="btn-save" class="btn-ghost">üíæ Sauvegarder</button>
          <button id="btn-load" class="btn-ghost">üìÇ Charger</button>
          <button id="btn-reset" class="btn-danger">‚ôªÔ∏è Recommencer</button>
        </div>
      </aside>

      <main class="panel">
        <div class="title"><h2 id="location">Lisi√®re de la for√™t de Mirval</h2><span class="meta" id="day">Jour 1 ‚Äî Aube</span></div>
        <div class="log" id="log"></div>
        <div class="divider"></div>
        <div class="title"><h2>Que fais-tu ?</h2></div>
        <div class="choices" id="choices"></div>
        <div class="footer">
          <div>Choisis √† l‚Äôinstinct. Les cons√©quences s‚Äôaffichent apr√®s.</div>
          <div id="lastRoll" class="meta"></div>
        </div>
      </main>
    </div>
  </div>

<script>
/* ====== RNG ====== */
const rng = (()=>{const seed=(crypto.getRandomValues?crypto.getRandomValues(new Uint32Array(1))[0]^Date.now():Date.now())>>>0;let s=seed>>>0;
function rand(){s^=s<<13;s>>>=0;s^=s>>17;s>>>=0;s^=s<<5;s>>>=0;return(s>>>0)/0xFFFFFFFF}function between(a,b){return Math.floor(rand()*(b-a+1))+a}
return{rand,between,seed}})();
document.getElementById('seedInfo').textContent = 'seed '+rng.seed;

/* ====== UI refs ====== */
const ui={
  log: document.getElementById('log'),
  choices: document.getElementById('choices'),
  hp: document.getElementById('hp'),
  hpmax: document.getElementById('hpmax'),
  hpbar: document.getElementById('hpbar'),
  gold: document.getElementById('gold'),
  lvl: document.getElementById('lvl'),
  xp: document.getElementById('xp'),
  inv: document.getElementById('inventory'),
  loc: document.getElementById('location'),
  day: document.getElementById('day'),
  lastRoll: document.getElementById('lastRoll'),
  status: document.getElementById('status'),
  pclass: document.getElementById('p-class'),
  pname: document.getElementById('p-name'),
  astr: document.getElementById('a-str'),
  aagi: document.getElementById('a-agi'),
  awis: document.getElementById('a-wis'),
  rep: document.getElementById('rep'),
  repLabel: document.getElementById('rep-label'),
  quests: document.getElementById('quests'),
};

function write(t,cls=''){const p=document.createElement('p'); if(cls)p.classList.add(cls); p.innerHTML=t; ui.log.appendChild(p); ui.log.scrollTop=ui.log.scrollHeight}
function clearChoices(){ui.choices.innerHTML=''}
function addChoice(label,fn,primary=false){const b=document.createElement('button'); if(primary)b.classList.add('btn-primary'); b.textContent=label; b.onclick=fn; ui.choices.appendChild(b)}
function d20(mod=0){const r=rng.between(1,20); const tot=r+mod; ui.lastRoll.textContent=`d20(${mod>=0?'+':''}${mod}) ‚Üí ${r} = ${tot}`; return {r,tot}}
function repText(n){return n>=30?'Vertueux':n<=-30?'Sombre':'Neutre'}

/* ====== State ====== */
function initialState(){
  return {
    name:'Eldarion', cls:'‚Äî',
    attrs:{STR:1,AGI:1,WIS:1},
    hp:22,hpMax:22,gold:12,level:1,xp:0,
    rep:0,
    day:1,time:'Aube',locationKey:'clairiere',location:'Lisi√®re de la for√™t de Mirval',
    inventory:[{name:'Vieille √©p√©e',desc:'+1 attaque'},{name:'Petite armure',desc:'+1 armure'}],
    potions:1,status:[],
    flags:{metHerbalist:false,metSmith:false,peasantSaved:false,fragments:0,bossUnlocked:false,torch:false,oracleSeen:false,ruinsUnlocked:true,grottoUnlocked:false},
    quests:{main:{title:'Le Chef Bandit',state:'En cours'}, side:[], artifacts:{title:'Fragments d‚Äôartefact (0/3)',state:'En cours'}},
    achievements:{},
    lastLabels:[],
    inCombat:false,enemy:null,
    skill:{name:'',cd:0,cooldown:0,desc:'',use:()=>{}}
  }
}
let state = JSON.parse(localStorage.getItem('mirval.save')||'null') || initialState();

/* ====== UI Update ====== */
function setStats(){
  ui.hp.textContent=state.hp; ui.hpmax.textContent=state.hpMax; ui.hpbar.style.width=Math.max(0,Math.min(100,Math.round(state.hp/state.hpMax*100)))+'%';
  ui.gold.textContent=state.gold; ui.lvl.textContent=state.level; ui.xp.textContent=state.xp;
  ui.status.textContent=state.status.length? state.status.map(s=>s.name).join(', '):'‚Äî';
  ui.pclass.textContent=state.cls; ui.pname.textContent=state.name;
  ui.astr.textContent=state.attrs.STR; ui.aagi.textContent=state.attrs.AGI; ui.awis.textContent=state.attrs.WIS;
  ui.rep.textContent=state.rep; ui.repLabel.textContent=repText(state.rep);
  ui.inv.innerHTML=''; state.inventory.forEach(it=>{const d=document.createElement('div'); d.className='stat'; d.innerHTML=`<b>${it.name}</b><span>${it.desc}</span>`; ui.inv.appendChild(d)});
  // Quests
  ui.quests.innerHTML='';
  const mq=document.createElement('div'); mq.className='stat'; mq.innerHTML=`<b>${state.quests.main.title}</b><span>${state.quests.main.state}</span>`; ui.quests.appendChild(mq);
  const aq=document.createElement('div'); aq.className='stat'; aq.innerHTML=`<b>${state.quests.artifacts.title.replace(/\d\/3/,state.flags.fragments+'/3')}</b><span>${state.quests.artifacts.state}</span>`; ui.quests.appendChild(aq);
  state.quests.side.forEach(q=>{const x=document.createElement('div'); x.className='stat'; x.innerHTML=`<b>${q.title}</b><span>${q.state}</span>`; ui.quests.appendChild(x)});
}
function heal(n){ state.hp=Math.min(state.hpMax,state.hp+n); setStats(); write(`+${n} PV`,'good') }
function damage(n,src=''){ state.hp=Math.max(0,state.hp-n); setStats(); write(`-${n} PV ${src?`(${src})`:''}`,'bad'); if(state.hp<=0) return gameOver()}
function gold(n){ state.gold=Math.max(0,state.gold+n); setStats(); write(`${n>=0?'+':''}${n} or`, n>=0?'good':'warn') }
function xp(n){ state.xp+=n; const need=20+(state.level-1)*15; write(`+${n} XP`,'info'); if(state.xp>=need){ state.level++; state.xp=0; state.hpMax+=5; state.hp=state.hpMax; write(`<b>Niveau ${state.level}</b> ‚Äî PV max +5`,'good') } setStats() }
function addItem(n,d){ state.inventory.push({name:n,desc:d}); setStats(); write(`Tu obtiens <b>${n}</b>.`,'good') }
function hasItem(n){ return state.inventory.some(i=>i.name===n) }
function rep(delta){ state.rep=Math.max(-100,Math.min(100,state.rep+delta)); setStats() }
function save(){ localStorage.setItem('mirval.save', JSON.stringify(state)); write('Sauvegard√©.','sys') }
function load(){ const raw=localStorage.getItem('mirval.save'); if(!raw){write('Aucune sauvegarde.','warn')} else { state=JSON.parse(raw); write('Sauvegarde charg√©e.','sys'); ui.log.innerHTML=''; setup() } }
function reset(){ state=initialState(); ui.log.innerHTML=''; setup(true); write('Nouvelle aventure !','sys') }
document.getElementById('btn-save').onclick=save; document.getElementById('btn-load').onclick=load; document.getElementById('btn-reset').onclick=reset;

/* ====== Choice system (anti-redondance) ====== */
function pickWeighted(list,k){
  const recent = new Set(state.lastLabels);
  let pool = list.flatMap(it => Array((it.w||1)).fill(it)).filter(it=> !recent.has(it.label));
  if(pool.length<k) pool = list.flatMap(it => Array((it.w||1)).fill(it));
  const out=[];
  for(let i=0;i<k && pool.length;i++){
    const idx=Math.floor(rng.rand()*pool.length);
    out.push(pool[idx]);
    pool=pool.filter((_,j)=>j!==idx);
  }
  state.lastLabels = [...out.map(o=>o.label), ...state.lastLabels].slice(0,8);
  return out;
}
function addPrimary(label,fn){ addChoice(label,fn,true) }

/* ====== Time & map ====== */
function setTime(){ const slots=['Aube','Matin','Midi','Apr√®s-midi','Cr√©puscule','Nuit']; let i=slots.indexOf(state.time); i=(i+1)%slots.length; if(i===0) state.day++; state.time=slots[i]; ui.day.textContent=`Jour ${state.day} ‚Äî ${state.time}` }
function gotoZone(key){
  state.locationKey=key;
  state.location= key==='marais'?'Marais de Vire-Saule': key==='clairiere'?'Clairi√®re des Lys': key==='colline'?'Colline de Rocfauve': key==='ruines'?'Ruines Oubli√©es':'Grotte S√©pulcrale';
  write(`üëâ Tu te diriges vers ${state.location}.`,'sys');
  explore(true);
}

/* ====== Status ====== */
function tickStatus(){
  state.status = state.status.filter(st=>{
    if(st.type==='poison'){ const d=rng.between(1,2); damage(d,'Poison'); st.dur--; }
    if(st.type==='bleed'){ damage(2,'Saignement'); st.dur--; }
    if(st.type==='slow'){ st.dur--; if(st.dur===0) write('üí® Tu te sens plus l√©ger.','info') }
    return st.dur>0 && state.hp>0;
  });
  setStats();
}

/* ====== Combat ====== */
function enemyArmor(){ return 10 + (hasItem('Bouclier en bois')?1:0) + (hasItem('Bouclier en fer')?2:0) + (hasItem('Cuir renforc√©')?2:0) }
function playerAtkMod(){ let m=(state.cls==='Guerrier'?2:0)+(state.attrs.STR>=3?1:0)+(hasItem('√âp√©e aff√ªt√©e')?1:0); return m }
function playerDef(){ return 10 + (state.cls==='Paladin'?1:0) + (state.attrs.AGI>=3?1:0) + (hasItem('Petite armure')?1:0) + (hasItem('Cuir renforc√©')?2:0) + (hasItem('Bouclier en fer')?2:0) }
function terrainPenalty(){ return state.locationKey==='marais'? -1 : 0 }

function combat(mon){ state.inCombat=true; state.enemy=JSON.parse(JSON.stringify(mon)); write(`<b>${mon.name}</b> appara√Æt !`,'warn'); combatTurn() }
function enemyAttack(){
  const e=state.enemy, roll=d20(e.hitMod).tot, def=playerDef() + terrainPenalty();
  if(roll>=def){
    let dmg=rng.between(1,3+e.tier);
    if(e.name==='Bandit des fourr√©s' && rng.rand()<0.2){ gold(-1); write('ü™ô Le bandit te d√©trousse !','warn') }
    damage(dmg,e.name);
    if(e.dotChance && rng.rand()<e.dotChance){ state.status.push({type:e.dotType,name:(e.dotType==='poison'?'Poison':'Saignement'),dur:rng.between(2,4)}); write('‚ö†Ô∏è Alt√©ration d‚Äô√©tat !','warn') }
  } else write(`${e.name} rate son attaque.`,'info');
}
function combatTurn(){
  if(state.hp<=0) return;
  const e=state.enemy; if(e.hp<=0){ afterCombat(); return }
  clearChoices();
  addPrimary('Attaquer', ()=>aimMenu());
  addChoice('Parer', ()=>{ const m=d20(e.hitMod).tot, armor=12+(state.cls==='R√¥deur'?2:1); if(m>=armor){ const dmg=Math.max(0,rng.between(1,3+e.tier)-2); damage(dmg,'Riposte') } else write('Tu pares compl√®tement.','good'); enemyAttack(); combatTurn() });
  addChoice('Comp√©tence', ()=>useSkill());
  addChoice(`Potion (${state.potions})`, ()=>{ if(state.potions<=0){ write("Plus de potions.",'warn'); return combatTurn() } state.potions--; heal(rng.between(8,12)); enemyAttack(); combatTurn() });
  addChoice('Fuir', ()=>{ const r=d20(state.attrs.AGI>=3?2:0).tot; if(r>=14){ write('Tu fuis le combat.','sys'); state.inCombat=false; state.enemy=null; explore() } else { write("√âchec de fuite !",'bad'); enemyAttack(); combatTurn() } });
}
function aimMenu(){
  clearChoices(); const e=state.enemy;
  addPrimary('Viser la t√™te', ()=>{ const r=d20(playerAtkMod()-2 + terrainPenalty()).tot; if(r>=e.ac+2){ const dmg=rng.between(6,10); e.hp-=dmg; write(`üéØ Coup √† la t√™te : -${dmg} PV`,'good') } else write('Tu manques la t√™te.','warn'); enemyAttack(); combatTurn() });
  addChoice('Viser le torse', ()=>{ const r=d20(playerAtkMod() + terrainPenalty()).tot; if(r>=e.ac){ const dmg=rng.between(3,7); e.hp-=dmg; write(`üó°Ô∏è Frappe au torse : -${dmg} PV`,'good') } else write('Tu manques.','warn'); enemyAttack(); combatTurn() });
  addChoice('Viser les jambes', ()=>{ const r=d20(playerAtkMod()+1 + terrainPenalty()).tot; if(r>=e.ac-1){ const dmg=rng.between(2,5); e.hp-=dmg; state.status.push({type:'slow',name:'Ralentissement',dur:2}); write(`ü¶µ Frappe aux jambes : -${dmg} PV (ennemi ralenti)`,`good`) } else write('Tu manques les jambes.','warn'); enemyAttack(); combatTurn() });
  addChoice('Annuler', combatTurn);
}
function useSkill(){
  const s=state.skill, e=state.enemy;
  if(!s.name){ write("Tu n'as pas de comp√©tence active.",'warn'); return combatTurn() }
  if(s.cd>0){ write('Comp√©tence en recharge.','warn'); return combatTurn() }
  s.use(e); s.cd=s.cooldown;
  if(e.hp>0){ enemyAttack(); }
  combatTurn();
}
function afterCombat(){
  const e=state.enemy; state.inCombat=false; state.enemy=null;
  let reward=rng.between(e.tier, e.tier*3); gold(reward); xp(rng.between(e.tier*3,e.tier*6));
  if(rng.rand()<0.35) state.potions++;
  if(rng.rand()<0.20 && !hasItem('√âp√©e aff√ªt√©e')) addItem('√âp√©e aff√ªt√©e','+1 attaque');
  if(e.name.includes('Bandit')){ state.flags.rumors=(state.flags.rumors||0)+1; if(state.flags.rumors>=3 && !state.flags.bossUnlocked){ state.flags.bossUnlocked=true; write('Tu apprends la cache du Chef Bandit.','info') } }
  if(e.name==='Chef Bandit'){ state.quests.main.state='Termin√©'; state.achievements.hero=(state.rep>=30); state.achievements.villain=(state.rep<=-30); ending(); return }
  explore();
}

/* ====== Events ====== */
function chest(){ const r=rng.between(1,100); if(r>92) addItem('Bouclier en fer','+2 armure'); else if(r>70){ state.potions++; write('Tu trouves une potion.','good') } else if(r>40) gold(rng.between(7,15)); else damage(rng.between(3,6),'Pi√®ge') }
function eventHerbalist(){
  write("üåø Une herboriste te fait signe.");
  clearChoices();
  addPrimary('S‚Äôapprocher', ()=>{ if(state.rep<-20){ write("Elle se d√©tourne : 'Je ne sers pas les cruels.'",'warn'); rep(-1); continueBtn(); return }
    write("Elle pr√©pare une mixture fumante‚Ä¶"); const cost=(state.rep>20?2:3); if(state.gold>=cost){ gold(-cost); heal(rng.between(6,12)); state.flags.metHerbalist=true } else write("Tu n'as pas assez d'or.",'warn'); continueBtn();
  });
  addChoice('Marchander', ()=>{ const r=d20(state.attrs.WIS>=3?2:0).tot; if(r>=15){ heal(rng.between(4,8)); write('Elle sourit : \"√Ä prix d‚Äôami.\"','good'); } else { write('Elle refuse.','warn') } continueBtn(); });
  addChoice('Partir', continueBtn);
}
function eventSmith(){
  write('‚öíÔ∏è Un forgeron itin√©rant inspecte tes armes.');
  clearChoices();
  addPrimary('Demander une am√©lioration', ()=>{ if(state.gold>=5){ gold(-5); addItem('√âp√©e aff√ªt√©e','+1 attaque') } else write("Pas assez d'or.",'warn'); continueBtn(); });
  addChoice('Commander un bouclier', ()=>{ if(state.gold>=6){ gold(-6); addItem('Bouclier en fer','+2 armure') } else write("Pas assez d'or.",'warn'); continueBtn(); });
  addChoice('Discuter', ()=>{ xp(3); continueBtn(); });
}
function eventBard(){
  write('üéª Un barde propose une chanson.');
  clearChoices();
  addPrimary('√âcouter', ()=>{ if(rng.rand()<0.7){ heal(rng.between(3,7)); } else { gold(-2); write('La bourse s‚Äôest all√©g√©e‚Ä¶','warn') } continueBtn(); });
  addChoice('L‚Äôignorer', continueBtn);
}
function eventRuins(){
  write('üèöÔ∏è Des ruines effondr√©es se dressent.');
  clearChoices();
  addPrimary('Fouiller', ()=>{ const r=d20(state.attrs.WIS>=3?1:0).tot; if(r>=16){ if(!state.flags.torch){ state.flags.torch=true; addItem('Torche ancienne','Permet d‚Äôexplorer la grotte') } else { state.flags.fragments++; write('Tu trouves un fragment d‚Äôartefact.','good') } } else if(r>=10){ chest() } else { damage(rng.between(2,5),'√âboulement') } continueBtn(); });
  addChoice('Partir', continueBtn);
}
function eventPeasant(){
  write('üßë‚Äçüåæ Un paysan encha√Æn√© appelle √† l‚Äôaide.');
  clearChoices();
  addPrimary('Le lib√©rer', ()=>{ const r=d20(state.attrs.STR>=3?2:0).tot; if(r>=14){ write('Les cha√Ænes c√®dent.','good'); rep(+5); state.flags.peasantSaved=true; state.quests.side.push({title:'Le paysan reconnaissant',state:'En attente'}); } else { damage(rng.between(1,4),'Effort') } continueBtn(); });
  addChoice('L‚Äôignorer', ()=>{ rep(-3); continueBtn(); });
}
function eventSanctuary(){
  write('‚õ™ Un ancien sanctuaire se d√©voile.');
  clearChoices();
  addPrimary('Prier', ()=>{ const night = state.time==='Nuit' || state.time==='Cr√©puscule'; const r=d20().tot + (night?1:0); if(r>=15){ heal(rng.between(6,12)); rep(+2) } else { damage(rng.between(2,6),'Pr√©sage'); rep(-1) } continueBtn(); });
  addChoice('D√©sacraliser', ()=>{ const r=d20(-1).tot; if(r>=16){ gold(rng.between(8,16)); rep(-3) } else { damage(rng.between(4,7),'Mal√©diction'); rep(-5) } continueBtn(); });
  addChoice('Partir', continueBtn);
}
function eventHermit(){
  write('üßô Un ermite t‚Äôobserve en silence.');
  clearChoices();
  addPrimary('Accepter sa d√©coction', ()=>{ if(rng.rand()<0.6){ heal(rng.between(5,10)); xp(3) } else { damage(rng.between(2,5),'Naus√©e') } continueBtn(); });
  addChoice('Acheter une breloque', ()=>{ if(state.gold>=5){ gold(-5); addItem("Breloque d'ermite","10% annule un mal"); state.flags.charm=1 } else write("Pas assez d'or.",'warn'); continueBtn(); });
  addChoice('Refuser', continueBtn);
}
function eventTrap(){ write('ü™§ Une corde s‚Äôenroule √† ta cheville !'); const r=d20(state.attrs.AGI>=3?2:0).tot; if(r>=13) write('Tu t‚Äôen sors de justesse.','good'); else damage(rng.between(2,5),'Pi√®ge') }
function eventOracle(){
  write('üîÆ Une voyante appara√Æt dans tes r√™ves.'); clearChoices();
  addPrimary('√âcouter la proph√©tie', ()=>{ write('‚ÄúQuand trois √©clats seront r√©unis, la porte s‚Äôouvrira.‚Äù','info'); state.flags.oracleSeen=true; continueBtn(); });
}

/* ====== Pools by zone ====== */
const mobs = {
  wolf: ()=>({name:'Loup affam√©',hp:10,maxHp:10,ac:11,hitMod:2,tier:1, dotChance:0}),
  bandit: ()=>({name:'Bandit des fourr√©s',hp:12,maxHp:12,ac:12,hitMod:3,tier:2, dotChance:0.1, dotType:'bleed'}),
  boar: ()=>({name:'Sanglier irascible',hp:11,maxHp:11,ac:11,hitMod:2,tier:1, dotChance:0.05, dotType:'bleed'}),
  harpy: ()=>({name:'Harpie du vent',hp:14,maxHp:14,ac:13,hitMod:4,tier:2, dotChance:0.2, dotType:'bleed'}),
  ghoul: ()=>({name:'Goule des roseaux',hp:13,maxHp:13,ac:12,hitMod:3,tier:2, dotChance:0.25, dotType:'poison'}),
  chief: ()=>({name:'Chef Bandit',hp:24,maxHp:24,ac:14,hitMod:5,tier:3, dotChance:0.3, dotType:'bleed'})
};

/* ====== Exploration ====== */
function explore(initial=false){
  setStats(); ui.loc.textContent=state.location; ui.day.textContent=`Jour ${state.day} ‚Äî ${state.time}`; clearChoices();
  if(!initial){ setTime(); } tickStatus(); if(state.hp<=0) return;

  if(state.day>=5 && !state.flags.oracleSeen) { eventOracle(); return }

  const zone=state.locationKey;
  const base=[
    {label:'Fouiller', act:()=>{ const r=d20(state.attrs.WIS>=3?1:0).tot; if(r>=18){ write('Tu d√©niches un coffre scell√©.','good'); chest()} else if(r>=12){ gold(rng.between(2,6)) } else if(r>=8){ if(rng.rand()<0.5) randomEncounter() } else { damage(rng.between(1,3),'Ronces') } continueBtn() }, w:2},
    {label:'Se reposer', act:()=>{ if(rng.rand()<0.35){ write('Un bruit approche pendant ton repos‚Ä¶','warn'); randomEncounter() } else { heal(rng.between(4,8)) } continueBtn() }, w:1},
    {label:'Utiliser un objet', act:()=>{ clearChoices(); addChoice(`Boire une potion (${state.potions})`, ()=>{ if(state.potions<=0){ write("Tu n'as pas de potion",'warn'); continueBtn() } else { state.potions--; heal(rng.between(8,12)); continueBtn() } }); addChoice('Annuler', explore); }, w:1}
  ];

  let pool=[];
  if(zone==='marais'){
    pool.push({label:'Suivre des feux-follets', act:eventSanctuary, w:2});
    pool.push({label:'Aider un captif', act:()=>{ if(!state.flags.peasantSaved) eventPeasant(); else { write('La berge est silencieuse.'); continueBtn(); } }, w:1});
    pool.push({label:'Traquer une goule', act:()=>combat(mobs.ghoul()), w:3});
    pool.push({label:'Affronter un loup', act:()=>combat(mobs.wolf()), w:2});
    pool.push({label:'Tomber sur un pi√®ge', act:()=>{ eventTrap(); continueBtn(); }, w:1});
  } else if(zone==='clairiere'){
    pool.push({label:'Croiser une herboriste', act:eventHerbalist, w:2});
    pool.push({label:'√âcouter un barde', act:eventBard, w:1});
    pool.push({label:'Chasser un sanglier', act:()=>combat(mobs.boar()), w:2});
    pool.push({label:'Autel moussu', act:eventSanctuary, w:2});
    pool.push({label:'Bandits embusqu√©s', act:()=>combat(mobs.bandit()), w:2});
  } else if(zone==='colline'){
    pool.push({label:'Rencontrer un ermite', act:eventHermit, w:1});
    pool.push({label:'Explorer des ruines', act:eventRuins, w:2});
    pool.push({label:'Affronter une harpie', act:()=>combat(mobs.harpy()), w:3});
    pool.push({label:'Croiser un forgeron', act:eventSmith, w:1});
  } else if(zone==='ruines'){
    pool.push({label:'Fouiller les d√©combres', act:eventRuins, w:3});
    pool.push({label:'Esquiver un √©boulement', act:()=>{ damage(rng.between(1,4),'√âboulement'); continueBtn(); }, w:1});
    pool.push({label:'Combattre des bandits', act:()=>combat(mobs.bandit()), w:2});
  } else if(zone==='grotte'){
    pool.push({label:'Combattre une goule ancienne', act:()=>combat({name:'Goule ancienne',hp:18,maxHp:18,ac:13,hitMod:5,tier:3,dotChance:0.35,dotType:'poison'}), w:3});
    pool.push({label:'√âchos inqui√©tants', act:()=>{ const r=d20().tot; if(r<10) damage(3,'Stalactite'); else write('Rien ne se passe.'); continueBtn(); }, w:1});
  }

  if(state.flags.bossUnlocked) pool.push({label:'Traquer le Chef Bandit', act:()=>combatBoss(), w:1});

  const nav=[
    {label:'‚Üí Marais', act:()=>gotoZone('marais'), w:1},
    {label:'‚Üí Clairi√®re', act:()=>gotoZone('clairiere'), w:1},
    {label:'‚Üí Colline', act:()=>gotoZone('colline'), w:1},
    {label:'‚Üí Ruines', act:()=>gotoZone('ruines'), w: state.flags.ruinsUnlocked?1:0},
    {label:'‚Üí Grotte', act:()=> state.flags.torch? gotoZone('grotte') : (write('Il fait trop sombre pour entrer.','warn'), continueBtn()), w:1}
  ].filter(x=>x.w>0);

  const dyn = pickWeighted(pool, 3 + (rng.rand()<0.4?1:0));
  const all = pickWeighted([...base, ...dyn, ...nav], 4);
  all.forEach((c,i)=> addChoice(c.label, c.act, i===0));
}

function randomEncounter(){
  const z=state.locationKey;
  if(z==='marais') combat(mobs.ghoul()); else if(z==='clairiere') combat(mobs.bandit()); else combat(mobs.harpy());
}

/* ====== Boss (phases) ====== */
function combatBoss(){
  const boss=mobs.chief();
  write('ü•∑ Tu t‚Äôinfiltres dans la planque du Chef Bandit.','warn');
  combat(boss);
  const _enemyAttack = enemyAttack;
  enemyAttack = function(){
    if(state.enemy && state.enemy.name==='Chef Bandit' && state.enemy.hp<=state.enemy.maxHp/2 && !state.enemy.enraged){
      state.enemy.enraged=true; state.enemy.hitMod+=1; write('üî• Le Chef Bandit entre en rage !','warn');
    }
    _enemyAttack();
  }
}

/* ====== Endings & Achievements ====== */
function ending(){
  clearChoices();
  if(state.rep>=30){ write('<b>Fin h√©ro√Øque :</b> Mirval te salue comme un sauveur.','good'); state.achievements.hero=true }
  else if(state.rep<=-30){ write('<b>Fin sombre :</b> ta l√©gende glace le sang des voyageurs.','bad'); state.achievements.villain=true }
  else { write('<b>Fin neutre :</b> tu quittes la for√™t, plus sage qu‚Äôavant.','info') }
  addChoice('Rejouer (New Game+)', ()=>{ localStorage.removeItem('mirval.save'); const st=initialState(); st.attrs.STR++; st.attrs.AGI++; st.attrs.WIS++; state=st; ui.log.innerHTML=''; setup(true); }, true);
  addChoice('Quitter', ()=>write('Merci d‚Äôavoir jou√© !'));
}

function continueBtn(){ addPrimary('Continuer', ()=>explore()) }

/* ====== Class selection ====== */
function chooseClass(){
  clearChoices();
  write('Choisis ta classe :','info');
  addPrimary('üõ°Ô∏è Guerrier', ()=>{ state.cls='Guerrier'; state.attrs.STR=3; state.skill={name:'Frappe vaillante',cooldown:3,cd:0,desc:'Attaque puissante',use:(e)=>{ const dmg=rng.between(2,6)+rng.between(2,6)+state.level; e.hp-=dmg; write(`üí• Frappe vaillante : -${dmg} PV`,'good') }}; startAdventure() });
  addChoice('üó°Ô∏è Voleur', ()=>{ state.cls='Voleur'; state.attrs.AGI=3; state.skill={name:'Coup de l‚Äôombre',cooldown:3,cd:0,desc:'Jet +4, 1d6 + or vol√©',use:(e)=>{ const r=d20(4).tot; if(r>=e.ac){ const steal=Math.min(3, state.gold); const dmg=rng.between(3,8)+steal; e.hp-=dmg; gold(steal); write(`üó°Ô∏è L‚Äôombre frappe : -${dmg} PV`,'good') } else write('Tu rates.','warn') }}; startAdventure() });
  addChoice('‚öïÔ∏è Paladin', ()=>{ state.cls='Paladin'; state.attrs.WIS=2; state.skill={name:'Lumi√®re',cooldown:3,cd:0,desc:'Soigne',use:(e)=>{ heal(rng.between(3,8)+state.level) }}; startAdventure() });
  addChoice('üèπ R√¥deur', ()=>{ state.cls='R√¥deur'; state.attrs.AGI=3; state.skill={name:'Tir pr√©cis',cooldown:2,cd:0,desc:'Jet +6, 1d8 d√©g√¢ts',use:(e)=>{ const r=d20(6).tot; if(r>=e.ac){ const dmg=rng.between(3,8); e.hp-=dmg; write(`üèπ Tir pr√©cis : -${dmg} PV`,'good') } else write('Tir manqu√©.','warn') }}; startAdventure() });
  addChoice('üîÆ Mystique', ()=>{ state.cls='Mystique'; state.attrs.WIS=3; state.skill={name:'Onde arcanique',cooldown:3,cd:0,desc:'1d8 & vuln√©rabilit√©',use:(e)=>{ const dmg=rng.between(3,8); e.hp-=dmg; e.dotChance=Math.min(0.6,(e.dotChance||0)+0.15); write(`üîÆ Onde arcanique : -${dmg} PV`,'good') }}; startAdventure() });
}

/* ====== Setup & Loop ====== */
function setup(isNew=false){
  setStats(); ui.loc.textContent=state.location; ui.day.textContent=`Jour ${state.day} ‚Äî ${state.time}`; clearChoices();
  if(isNew || ui.log.childElementCount===0){
    write("Tu es √† la lisi√®re de la for√™t de Mirval. Des rumeurs parlent d'un Chef Bandit et d‚Äôantiques fragments.",'sys');
    chooseClass(); return;
  }
  explore(true);
}
function startAdventure(){ ui.log.innerHTML=''; write('L‚Äôaventure commence !','info'); setStats(); explore(true) }

function gameOver(){
  state.inCombat=false; write('<b>‚ò†Ô∏è Tu t‚Äôeffondres‚Ä¶</b>','bad'); localStorage.removeItem('mirval.save');
  clearChoices(); addPrimary('Recommencer', ()=>{ state=initialState(); ui.log.innerHTML=''; setup(true) })
}

/* Cooldown tick at each exploration */
const _explore = explore;
explore = function(...args){ if(state.skill && state.skill.cd>0) state.skill.cd--; _explore(...args) }

/* PWA */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js') ) }

/* Start */
setup(ui.log.childElementCount===0);
</script>
</body>
</html>
